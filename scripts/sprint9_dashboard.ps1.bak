param(
  [string]$Freq = '5min',
  [float]$Notional = 10000,
  [float]$CommissionBps = 0.5,
  [switch]$RunGrid = $false
)
$ErrorActionPreference = 'Stop'
$ROOT = (Get-Location).Path
$Py = Join-Path $ROOT '.venv/Scripts/python.exe'
$ExecPS = Join-Path $ROOT 'scripts/sprint8_cost_model.ps1'
$BtPS   = Join-Path $ROOT 'scripts/sprint9_backtest.ps1'
$GridPS = Join-Path $ROOT 'scripts/sprint9_cost_grid.ps1'
$OUT = Join-Path $ROOT 'output'

function Info($m){ $ts=(Get-Date).ToUniversalTime().ToString('s')+'Z'; Write-Host "[$ts] [DASH] $m" }

# 1) Execution & Costs
Info "Execution & Costs…"
pwsh -File $ExecPS -Freq $Freq -Notional $Notional -CommissionBps $CommissionBps

# 2) Backtest
Info "Backtest…"
pwsh -File $BtPS -Freq $Freq

# 3) Optional: Grid
if($RunGrid){
  Info "Cost Grid…"
  pwsh -File $GridPS -Freq $Freq
}

# 3b) Plot & Summary
$Py = Join-Path $ROOT '.venv/Scripts/python.exe'
$PlotPy = Join-Path $ROOT 'scripts/sprint9_plot.py'
Write-Host "[DASH] Plot & Summary…"
& $Py $PlotPy --freq $Freq

# 4) Summary (PF/Sharpe aus Markdown parsen)
$perf = Join-Path $OUT 'performance_report.md'
if (Test-Path $perf) {
  $txt = Get-Content $perf -Raw
  $pf    = [regex]::Match($txt, 'With Costs\s*\r?\n- PF:\s*([0-9\.\-NaN]+)').Groups[1].Value
  $sharpe= [regex]::Match($txt, 'With Costs[\s\S]*?- Sharpe:\s*([0-9\.\-NaN]+)').Groups[1].Value
  $trades= [regex]::Match($txt, 'With Costs[\s\S]*?- Trades:\s*([0-9]+)').Groups[1].Value
  Write-Host "[DASH] PF(with costs): $pf  | Sharpe: $sharpe  | Trades: $trades"
  $png = Join-Path $OUT "equity_curve_${Freq}.png"
  if(Test-Path $png){ Write-Host "[DASH] Equity PNG: $png" }
} else {
  Write-Host "[DASH] [WARN] performance_report.md nicht gefunden"
}

# 4) Summary
$perf = Join-Path $OUT 'performance_report.md'
$grid = Join-Path $OUT 'cost_grid_report.md'
$orders = Join-Path $OUT 'orders.csv'
if(Test-Path $perf){ Info "[OK] Performance: $perf" } else { Info "[WARN] Performance fehlt" }
if($RunGrid){ if(Test-Path $grid){ Info "[OK] Grid: $grid" } else { Info "[WARN] Grid-Report fehlt" } }
if(Test-Path $orders){ Info "[OK] Orders: $orders" }
Info "DONE"
