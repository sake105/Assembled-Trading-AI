#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
One-time ZERO-DATA SEEDER for a fresh project after a move.
Creates tiny, vendor-agnostic OHLCV samples so the pipeline has something
valid to ingest. Safe to delete later.

Outputs
-------
- data/raw/1min/demo_1min.csv
- output/aggregates/assembled_intraday_5min.parquet
"""
from __future__ import annotations
import numpy as np
import pandas as pd
from pathlib import Path
from datetime import datetime, timezone, timedelta

ROOT = Path(__file__).resolve().parents[1]
RAW_1M = ROOT / 'data' / 'raw' / '1min'
AGG   = ROOT / 'output' / 'aggregates'
RAW_1M.mkdir(parents=True, exist_ok=True)
AGG.mkdir(parents=True, exist_ok=True)

SYMS = ['AAPL','MSFT']
N_MIN = 8 * 60  # 8 hours of 1-min bars

now = pd.Timestamp.utcnow().floor('min')
start = now - pd.Timedelta(minutes=N_MIN)
idx = pd.date_range(start, now, freq='1min', inclusive='left', tz='UTC')

rng = np.random.default_rng(7)
frames = []
for s in SYMS:
    ret = rng.normal(0, 0.0009, len(idx))
    price = 100 * np.exp(np.cumsum(ret))
    open_ = price * (1 + rng.normal(0, 0.0003, len(idx)))
    high  = np.maximum.reduce([open_, price, open_ * (1 + np.abs(rng.normal(0, 0.0007, len(idx))))])
    low   = np.minimum.reduce([open_, price, open_ * (1 - np.abs(rng.normal(0, 0.0007, len(idx))))])
    vol   = rng.integers(1_000, 50_000, len(idx)).astype(float)
    df = pd.DataFrame({
        'timestamp': idx.tz_convert(None),
        'symbol': s,
        'open': open_,
        'high': high,
        'low': low,
        'close': price,
        'volume': vol,
    })
    frames.append(df)

raw = pd.concat(frames, ignore_index=True)
raw.to_csv(RAW_1M / 'demo_1min.csv', index=False)
print(f"[OK] wrote {RAW_1M / 'demo_1min.csv'} rows={len(raw)}")

# quick 5-min downsample (OHLCV)
rawu = raw.copy()
rawu['timestamp'] = pd.to_datetime(rawu['timestamp'], utc=True)
agg = []
for sym, g in rawu.groupby('symbol'):
    g = g.set_index('timestamp').sort_index()
    o = g['open'].resample('5min').first()
    h = g['high'].resample('5min').max()
    l = g['low'].resample('5min').min()
    c = g['close'].resample('5min').last()
    v = g['volume'].resample('5min').sum()
    out = pd.DataFrame({'timestamp': o.index.tz_convert(None),
                        'symbol': sym,
                        'open': o.values,
                        'high': h.values,
                        'low': l.values,
                        'close': c.values,
                        'volume': v.values})
    agg.append(out)
agg = pd.concat(agg, ignore_index=True)
AGG_FILE = AGG / 'assembled_intraday_5min.parquet'
agg.to_parquet(AGG_FILE, index=False)
print(f"[OK] wrote {AGG_FILE} rows={len(agg)}")

print("[DONE] Seed complete. You can now run sprint8_feature_engineering.py --freq 5min")
